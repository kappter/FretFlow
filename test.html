<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>Music Theory Modes</title>
    <style>
        :root {
            --theme-color: #00ffcc;
            --theme-text: #e0e0e0;
            --theme-bg: #2a2a2a;
            --theme-high-contrast: #ffeb3b;
            --theme-text-high-contrast: #ffffff;
            --theme-bg-high-contrast: #1a1a1a;
        }
        body {
            font-family: 'Roboto', sans-serif;
            background: linear-gradient(135deg, #1a1a1a, #2c2c2c);
            color: var(--theme-text);
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-size: 16px;
            line-height: 1.5;
        }
        .container {
            max-width: 100%;
            background: var(--theme-bg);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(var(--theme-color-rgb, 0, 255, 204), 0.2);
            transition: transform 0.3s ease;
        }
        .container:hover {
            transform: translateY(-3px);
        }
        h1 {
            text-align: center;
            color: var(--theme-color);
            text-shadow: 0 0 8px rgba(var(--theme-color-rgb, 0, 255, 204), 0.5);
            margin-bottom: 15px;
            font-size: 22px;
        }
        .relative-modes {
            text-align: center;
            margin-bottom: 15px;
            font-size: 16px;
            color: var(--theme-text);
            background: #333;
            padding: 8px;
            border-radius: 5px;
        }
        .relative-modes span {
            color: var(--theme-color);
            font-weight: bold;
        }
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
            align-items: stretch;
        }
        details summary {
            font-size: 16px;
            padding: 8px;
            background: #3a3a3a;
            border-radius: 5px;
            cursor: pointer;
            outline: none;
        }
        details[open] summary {
            background: #4a4a4a;
        }
        select, input[type="color"], button {
            padding: 10px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            background: #3a3a3a;
            color: var(--theme-text);
            cursor: pointer;
            transition: background 0.3s ease;
            height: 48px;
            width: 100%;
            box-sizing: border-box;
        }
        select:hover, input[type="color"]:hover, button:hover {
            background: #4a4a4a;
        }
        input[type="color"] {
            height: 50px;
        }
        button {
            background: var(--theme-color);
            color: #1a1a1a;
            font-weight: bold;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #444;
        }
        th {
            background: var(--theme-color);
            color: #1a1a1a;
            text-transform: uppercase;
            font-weight: bold;
        }
        td {
            background: #333;
        }
        tr:hover td {
            background: #444;
        }
        .canvas-container {
            margin-top: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: stretch;
        }
        canvas {
            background: #333;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(var(--theme-color-rgb, 0, 255, 204), 0.1);
            touch-action: pan-y;
            max-width: 100%;
        }
        .canvas-label {
            font-size: 16px;
            color: var(--theme-color);
            margin-bottom: 8px;
            text-align: center;
        }
        .toggle-container {
            text-align: center;
            margin: 10px 0;
        }
        .high-contrast body {
            background: var(--theme-bg-high-contrast);
            color: var(--theme-text-high-contrast);
        }
        .high-contrast .container {
            background: var(--theme-bg-high-contrast);
        }
        .high-contrast .relative-modes,
        .high-contrast td {
            background: #2c2c2c;
        }
        .high-contrast th {
            background: var(--theme-high-contrast);
        }
        .high-contrast .relative-modes span,
        .high-contrast .canvas-label,
        .high-contrast h1 {
            color: var(--theme-high-contrast);
            text-shadow: 0 0 8px rgba(var(--theme-high-contrast-rgb, 255, 235, 59), 0.5);
        }
        @media (max-width: 480px) {
            body { padding: 5px; }
            .container { padding: 8px; }
            h1 { font-size: 20px; }
            .relative-modes { font-size: 14px; padding: 6px; }
            table { display: block; overflow-x: auto; white-space: nowrap; }
            th, td { font-size: 14px; padding: 6px; }
            select, input[type="color"], button { font-size: 14px; height: 44px; }
            #pianoCanvas { display: none; }
            .piano-visible #pianoCanvas { display: block; }
        }
        @media (orientation: landscape) {
            canvas { max-width: 80%; margin: 0 auto; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Music Theory Modes</h1>
        <div class="toggle-container">
            <button id="contrastToggle">Toggle High Contrast</button>
            <button id="pianoToggle">Show Piano Roll</button>
            <button id="fretboardToggle">Show Full Fretboard</button>
        </div>
        <details open>
            <summary>Settings</summary>
            <div class="controls">
                <select id="notationSelect" aria-label="Select note notation">
                    <option value="sharp">Sharps</option>
                    <option value="flat">Flats</option>
                </select>
                <select id="tuningSelect" aria-label="Select guitar tuning">
                    <option value="standard">Standard Tuning</option>
                    <option value="dropd">Drop D Tuning</option>
                </select>
                <select id="stringOrderSelect" aria-label="Select string order">
                    <option value="highBottom">High String Bottom</option>
                    <option value="lowBottom">Low String Bottom</option>
                </select>
                <input type="color" id="themeColor" value="#00ffcc" title="Select Theme Color" aria-label="Select theme color">
            </div>
        </details>
        <details open>
            <summary>Scale Selection</summary>
            <div class="controls">
                <select id="keySelect" aria-label="Select musical key">
                    <option value="C">C</option>
                    <option value="C#">C#</option>
                    <option value="D">D</option>
                    <option value="D#">D#</option>
                    <option value="E">E</option>
                    <option value="F">F</option>
                    <option value="F#">F#</option>
                    <option value="G">G</option>
                    <option value="G#">G#</option>
                    <option value="A">A</option>
                    <option value="A#">A#</option>
                    <option value="B">B</option>
                </select>
                <select id="modeSelect" aria-label="Select musical mode">
                    <option value="Ionian">Ionian (Major)</option>
                    <option value="Dorian">Dorian</option>
                    <option value="Phrygian">Phrygian</option>
                    <option value="Lydian">Lydian</option>
                    <option value="Mixolydian">Mixolydian</option>
                    <option value="Aeolian">Aeolian (Natural Minor)</option>
                    <option value="Locrian">Locrian</option>
                    <option value="MajorPentatonic">Major Pentatonic</option>
                    <option value="MinorPentatonic">Minor Pentatonic</option>
                    <option value="HarmonicMinor">Harmonic Minor</option>
                    <option value="LocrianNat6">Locrian ♮6</option>
                    <option value="IonianAug">Ionian Augmented</option>
                    <option value="DorianSharp4">Dorian ♯4</option>
                    <option value="PhrygianDominant">Phrygian Dominant</option>
                    <option value="LydianSharp2">Lydian ♯2</option>
                    <option value="SuperLocrianBB7">Super Locrian ♭♭7</option>
                    <option value="MelodicMinor">Melodic Minor</option>
                    <option value="DorianFlat2">Dorian ♭2</option>
                    <option value="LydianAugmented">Lydian Augmented</option>
                    <option value="LydianDominant">Lydian Dominant</option>
                    <option value="MixolydianFlat6">Mixolydian ♭6</option>
                    <option value="LocrianNat2">Locrian ♮2</option>
                    <option value="Altered">Altered Scale (Super Locrian)</option>
                    <option value="WholeTone">Whole Tone</option>
                    <option value="DiminishedHW">Diminished (Half–Whole)</option>
                    <option value="DiminishedWH">Diminished (Whole–Half)</option>
                    <option value="Blues">Blues Scale</option>
                    <option value="BebopMajor">Bebop Major</option>
                    <option value="BebopDominant">Bebop Dominant</option>
                    <option value="BebopDorian">Bebop Dorian</option>
                </select>
            </div>
        </details>
        <div id="relativeModes" class="relative-modes"></div>
        <table id="modeTable">
            <thead>
                <tr>
                    <th>Property</th>
                    <th>Details</th>
                </tr>
            </thead>
            <tbody id="tableBody"></tbody>
        </table>
        <div class="canvas-container">
            <div class="canvas-label">Guitar Fretboard <span id="fretboardKeyMode"></span></div>
            <canvas id="fretboardCanvas"></canvas>
            <div class="canvas-label piano-label">Piano Roll <span id="pianoKeyMode"></span></div>
            <canvas id="pianoCanvas"></canvas>
        </div>
    </div>
    <script>
        let currentNotation = 'sharp';
        let currentTuning = 'standard';
        let currentStringOrder = 'highBottom';
        let themeColor = '#00ffcc';
        let modesData = {};
        let debounceTimeout;
        let isHighContrast = false;
        let isFullFretboard = false;
        let maxFrets = window.innerWidth <= 480 ? 8 : 14;

        const modes = ["Ionian", "Dorian", "Phrygian", "Lydian", "Mixolydian", "Aeolian", "Locrian", "MajorPentatonic", "MinorPentatonic", "HarmonicMinor", "LocrianNat6", "IonianAug", "DorianSharp4", "PhrygianDominant", "LydianSharp2", "SuperLocrianBB7", "MelodicMinor", "DorianFlat2", "LydianAugmented", "LydianDominant", "MixolydianFlat6", "LocrianNat2", "Altered", "WholeTone", "DiminishedHW", "DiminishedWH", "Blues", "BebopMajor", "BebopDominant", "BebopDorian"];
        const sharpNotes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const flatNotes = ["C", "Db", "D", "Eb", "E", "F", "Gb", "G", "Ab", "A", "Bb", "B"];
        const intervalPatterns = {
            Ionian: ["Root", "Major 2nd", "Major 3rd", "Perfect 4th", "Perfect 5th", "Major 6th", "Major 7th"],
            Dorian: ["Root", "Major 2nd", "Minor 3rd", "Perfect 4th", "Perfect 5th", "Major 6th", "Minor 7th"],
            Phrygian: ["Root", "Minor 2nd", "Minor 3rd", "Perfect 4th", "Perfect 5th", "Minor 6th", "Minor 7th"],
            Lydian: ["Root", "Major 2nd", "Major 3rd", "Augmented 4th", "Perfect 5th", "Major 6th", "Major 7th"],
            Mixolydian: ["Root", "Major 2nd", "Major 3rd", "Perfect 4th", "Perfect 5th", "Major 6th", "Minor 7th"],
            Aeolian: ["Root", "Major 2nd", "Minor 3rd", "Perfect 4th", "Perfect 5th", "Minor 6th", "Minor 7th"],
            Locrian: ["Root", "Minor 2nd", "Minor 3rd", "Perfect 4th", "Diminished 5th", "Minor 6th", "Minor 7th"],
            MajorPentatonic: ["Root", "Major 2nd", "Major 3rd", "Perfect 5th", "Major 6th"],
            MinorPentatonic: ["Root", "Minor 3rd", "Perfect 4th", "Perfect 5th", "Minor 7th"],
            HarmonicMinor: ["Root", "Major 2nd", "Minor 3rd", "Perfect 4th", "Perfect 5th", "Minor 6th", "Major 7th"],
            LocrianNat6: ["Root", "Minor 2nd", "Minor 3rd", "Perfect 4th", "Diminished 5th", "Major 6th", "Minor 7th"],
            IonianAug: ["Root", "Major 2nd", "Major 3rd", "Perfect 4th", "Augmented 5th", "Major 6th", "Major 7th"],
            DorianSharp4: ["Root", "Major 2nd", "Minor 3rd", "Augmented 4th", "Perfect 5th", "Major 6th", "Minor 7th"],
            PhrygianDominant: ["Root", "Minor 2nd", "Major 3rd", "Perfect 4th", "Perfect 5th", "Minor 6th", "Minor 7th"],
            LydianSharp2: ["Root", "Augmented 2nd", "Minor 3rd", "Augmented 4th", "Perfect 5th", "Major 6th", "Major 7th"],
            SuperLocrianBB7: ["Root", "Minor 2nd", "Minor 3rd", "Major 3rd", "Diminished 5th", "Minor 6th", "Diminished 7th"],
            MelodicMinor: ["Root", "Major 2nd", "Minor 3rd", "Perfect 4th", "Perfect 5th", "Major 6th", "Major 7th"],
            DorianFlat2: ["Root", "Minor 2nd", "Minor 3rd", "Perfect 4th", "Perfect 5th", "Major 6th", "Minor 7th"],
            LydianAugmented: ["Root", "Major 2nd", "Major 3rd", "Augmented 4th", "Augmented 5th", "Major 6th", "Major 7th"],
            LydianDominant: ["Root", "Major 2nd", "Major 3rd", "Augmented 4th", "Perfect 5th", "Major 6th", "Minor 7th"],
            MixolydianFlat6: ["Root", "Major 2nd", "Major 3rd", "Perfect 4th", "Perfect 5th", "Minor 6th", "Minor 7th"],
            LocrianNat2: ["Root", "Major 2nd", "Minor 3rd", "Perfect 4th", "Diminished 5th", "Minor 6th", "Minor 7th"],
            Altered: ["Root", "Minor 2nd", "Minor 3rd", "Major 3rd", "Diminished 5th", "Minor 6th", "Minor 7th"],
            WholeTone: ["Root", "Major 2nd", "Major 3rd", "Augmented 4th", "Augmented 5th", "Major 7th"],
            DiminishedHW: ["Root", "Minor 2nd", "Minor 3rd", "Major 3rd", "Perfect 4th", "Augmented 4th", "Diminished 6th", "Minor 6th"],
            DiminishedWH: ["Root", "Major 2nd", "Minor 3rd", "Perfect 4th", "Diminished 5th", "Augmented 5th", "Major 6th", "Augmented 6th"],
            Blues: ["Root", "Minor 3rd", "Perfect 4th", "Diminished 5th", "Perfect 5th", "Minor 7th"],
            BebopMajor: ["Root", "Major 2nd", "Major 3rd", "Perfect 4th", "Perfect 5th", "Major 6th", "Minor 7th", "Major 7th"],
            BebopDominant: ["Root", "Major 2nd", "Major 3rd", "Perfect 4th", "Perfect 5th", "Major 6th", "Minor 7th", "Major 7th"],
            BebopDorian: ["Root", "Major 2nd", "Minor 3rd", "Perfect 4th", "Perfect 5th", "Major 6th", "Minor 7th", "Major 7th"]
        };
        const modePatterns = {
            Ionian: [0, 2, 4, 5, 7, 9, 11],
            Dorian: [0, 2, 3, 5, 7, 9, 10],
            Phrygian: [0, 1, 3, 5, 7, 8, 10],
            Lydian: [0, 2, 4, 6, 7, 9, 11],
            Mixolydian: [0, 2, 4, 5, 7, 9, 10],
            Aeolian: [0, 2, 3, 5, 7, 8, 10],
            Locrian: [0, 1, 3, 5, 6, 8, 10],
            MajorPentatonic: [0, 2, 4, 7, 9],
            MinorPentatonic: [0, 3, 5, 7, 10],
            HarmonicMinor: [0, 2, 3, 5, 7, 8, 11],
            LocrianNat6: [0, 1, 3, 5, 6, 9, 10],
            IonianAug: [0, 2, 4, 5, 8, 9, 11],
            DorianSharp4: [0, 2, 3, 6, 7, 9, 10],
            PhrygianDominant: [0, 1, 4, 5, 7, 8, 10],
            LydianSharp2: [0, 3, 4, 6, 7, 9, 11],
            SuperLocrianBB7: [0, 1, 3, 4, 6, 8, 9],
            MelodicMinor: [0, 2, 3, 5, 7, 9, 11],
            DorianFlat2: [0, 1, 3, 5, 7, 9, 10],
            LydianAugmented: [0, 2, 4, 6, 8, 9, 11],
            LydianDominant: [0, 2, 4, 6, 7, 9, 10],
            MixolydianFlat6: [0, 2, 4, 5, 7, 8, 10],
            LocrianNat2: [0, 2, 3, 5, 6, 8, 10],
            Altered: [0, 1, 3, 4, 6, 8, 10],
            WholeTone: [0, 2, 4, 6, 8, 10],
            DiminishedHW: [0, 1, 3, 4, 6, 7, 9, 10],
            DiminishedWH: [0, 2, 3, 5, 6, 8, 9, 11],
            Blues: [0, 3, 5, 6, 7, 10],
            BebopMajor: [0, 2, 4, 5, 7, 9, 11],
            BebopDominant: [0, 2, 4, 5, 7, 9, 10, 11],
            BebopDorian: [0, 2, 3, 5, 7, 9, 10, 11]
        };
        const modeOffsets = {
            Ionian: 0,
            Dorian: 2,
            Phrygian: 4,
            Lydian: 5,
            Mixolydian: 7,
            Aeolian: 9,
            Locrian: 11
        };
        const chordQualities = {
            Ionian: ["maj", "min", "min", "maj", "maj", "min", "dim"],
            Dorian: ["min", "min", "maj", "maj", "min", "dim", "maj"],
            Phrygian: ["min", "maj", "maj", "min", "dim", "maj", "min"],
            Lydian: ["maj", "maj", "min", "dim", "maj", "min", "min"],
            Mixolydian: ["maj", "min", "dim", "maj", "min", "min", "maj"],
            Aeolian: ["min", "dim", "maj", "min", "min", "maj", "maj"],
            Locrian: ["dim", "maj", "min", "min", "maj", "maj", "min"],
            HarmonicMinor: ["min", "dim", "aug", "min", "maj", "maj", "dim"],
            LocrianNat6: ["dim", "aug", "min", "maj", "maj", "dim", "min"],
            IonianAug: ["aug", "min", "maj", "maj", "dim", "min", "dim"],
            DorianSharp4: ["min", "maj", "maj", "dim", "min", "dim", "aug"],
            PhrygianDominant: ["maj", "maj", "dim", "min", "dim", "aug", "min"],
            LydianSharp2: ["maj", "dim", "min", "dim", "aug", "min", "maj"],
            SuperLocrianBB7: ["dim", "min", "dim", "aug", "min", "maj", "maj"],
            MelodicMinor: ["min", "dim", "aug", "min", "maj", "dim", "dim"],
            DorianFlat2: ["dim", "aug", "min", "maj", "dim", "dim", "min"],
            LydianAugmented: ["aug", "min", "maj", "dim", "dim", "min", "dim"],
            LydianDominant: ["min", "maj", "dim", "dim", "min", "dim", "aug"],
            MixolydianFlat6: ["maj", "dim", "dim", "min", "dim", "aug", "min"],
            LocrianNat2: ["dim", "dim", "min", "dim", "aug", "min", "maj"],
            Altered: ["dim", "min", "dim", "aug", "min", "maj", "dim"]
        };
        const fourNoteQualities = {
            Ionian: ["maj7", "min7", "min7", "maj7", "7", "min7", "min7b5"],
            Dorian: ["min7", "min7", "maj7", "7", "min7", "min7b5", "maj7"],
            Phrygian: ["min7", "maj7", "7", "min7", "min7b5", "maj7", "min7"],
            Lydian: ["maj7", "7", "min7", "min7b5", "maj7", "min7", "min7"],
            Mixolydian: ["7", "min7", "min7b5", "maj7", "min7", "min7", "maj7"],
            Aeolian: ["min7", "min7b5", "maj7", "min7", "min7", "maj7", "7"],
            Locrian: ["min7b5", "maj7", "min7", "min7", "maj7", "7", "min7"],
            HarmonicMinor: ["minmaj7", "m7b5", "7#5", "m7", "maj7", "maj7", "dim7"],
            LocrianNat6: ["m7b5", "7#5", "m7", "maj7", "maj7", "dim7", "minmaj7"],
            IonianAug: ["7#5", "m7", "maj7", "maj7", "dim7", "minmaj7", "m7b5"],
            DorianSharp4: ["m7", "maj7", "maj7", "dim7", "minmaj7", "m7b5", "7#5"],
            PhrygianDominant: ["maj7", "maj7", "dim7", "minmaj7", "m7b5", "7#5", "m7"],
            LydianSharp2: ["maj7", "dim7", "minmaj7", "m7b5", "7#5", "m7", "maj7"],
            SuperLocrianBB7: ["dim7", "minmaj7", "m7b5", "7#5", "m7", "maj7", "maj7"],
            MelodicMinor: ["minmaj7", "m7", "maj7#5", "7", "7", "m7b5", "m7b5"],
            DorianFlat2: ["m7", "maj7#5", "7", "7", "m7b5", "m7b5", "minmaj7"],
            LydianAugmented: ["maj7#5", "7", "7", "m7b5", "m7b5", "minmaj7", "m7"],
            LydianDominant: ["7", "7", "m7b5", "m7b5", "minmaj7", "m7", "maj7#5"],
            MixolydianFlat6: ["7", "m7b5", "m7b5", "minmaj7", "m7", "maj7#5", "7"],
            LocrianNat2: ["m7b5", "m7b5", "minmaj7", "m7", "maj7#5", "7", "7"],
            Altered: ["m7b5", "minmaj7", "m7", "maj7#5", "7", "7", "m7b5"]
        };
        const modeEmotions = {
            Ionian: "Bright, happy, triumphant",
            Dorian: "Soulful, introspective, jazzy",
            Phrygian: "Exotic, tense, mysterious",
            Lydian: "Dreamy, ethereal, floating",
            Mixolydian: "Upbeat, bluesy, rock-oriented",
            Aeolian: "Sad, melancholic, somber",
            Locrian: "Dark, unstable, dissonant",
            MajorPentatonic: "Bright, simple, uplifting",
            MinorPentatonic: "Bluesy, raw, emotional",
            HarmonicMinor: "Exotic, tense, dramatic",
            LocrianNat6: "Dark, mystical, unstable",
            IonianAug: "Mysterious, tense, augmented",
            DorianSharp4: "Modal, suspended, lydian tinge",
            PhrygianDominant: "Flamenco, Spanish, fiery",
            LydianSharp2: "Exotic, otherworldly, tense",
            SuperLocrianBB7: "Dissonant, chaotic, extreme",
            MelodicMinor: "Jazzy, ascending, sophisticated",
            DorianFlat2: "Phrygian-jazzy, dark minor",
            LydianAugmented: "Ethereal, bright tension",
            LydianDominant: "Lydian blues, dominant color",
            MixolydianFlat6: "Dark dominant, melancholic",
            LocrianNat2: "Subdued tension, altered locrian",
            Altered: "Jazzy tension, altered dominant",
            WholeTone: "Ambiguous, dreamy, impressionistic",
            DiminishedHW: "Tense, chromatic, dominant approach",
            DiminishedWH: "Symmetric, melodic, mysterious",
            Blues: "Soulful, gritty, expressive",
            BebopMajor: "Swinging, chromatic, bebop swing",
            BebopDominant: "Jazz dominant, passing tones",
            BebopDorian: "Dorian with swing, modal jazz"
        };

        function getSemitone(note, notation) {
            const sharpMap = { "C": 0, "C#": 1, "D": 2, "D#": 3, "E": 4, "F": 5, "F#": 6, "G": 7, "G#": 8, "A": 9, "A#": 10, "B": 11 };
            const flatMap = { "C": 0, "Db": 1, "D": 2, "Eb": 3, "E": 4, "F": 5, "Gb": 6, "G": 7, "Ab": 8, "A": 9, "Bb": 10, "B": 11 };
            return (notation === 'flat' ? flatMap : sharpMap)[note] || 0;
        }

        function getNoteFromSemitone(semitone, notation) {
            return (notation === 'flat' ? flatNotes : sharpNotes)[semitone];
        }

        function getGuitarStrings(tuning) {
            const standard = [
                { note: "E", octave: 2, semitone: 4 },
                { note: "A", octave: 2, semitone: 9 },
                { note: "D", octave: 3, semitone: 2 },
                { note: "G", octave: 3, semitone: 7 },
                { note: "B", octave: 3, semitone: 11 },
                { note: "E", octave: 4, semitone: 4 }
            ];
            if (tuning === 'dropd') {
                standard[0] = { note: "D", octave: 2, semitone: 2 };
            }
            return standard;
        }

        function generateChords(notes, mode) {
            const triads = [], fourNote = [], fiveNote = [], sixNote = [];
            if (chordQualities[mode] && notes.length >= 3) {
                const num = Math.min(notes.length, 7);
                for (let i = 0; i < num; i++) {
                    triads.push(`${notes[i]}${chordQualities[mode][i]}`);
                    let q = fourNoteQualities[mode][i];
                    fourNote.push(`${notes[i]}${q}`);
                    fiveNote.push(`${notes[i]}${q.replace("7", "9")}`);
                    sixNote.push(`${notes[i]}${q.replace("7", "11")}`);
                }
            }
            return { triads, fourNote, fiveNote, sixNote };
        }

        function generateData(notation) {
            const notesList = notation === 'sharp' ? sharpNotes : flatNotes;
            const data = {};
            for (let rootName of notesList) {
                const rootSemitone = getSemitone(rootName, notation);
                data[rootName] = {};
                for (let mode of modes) {
                    const pattern = modePatterns[mode];
                    const notes = pattern.map(p => getNoteFromSemitone((rootSemitone + p) % 12, notation));
                    const chords = generateChords(notes, mode);
                    data[rootName][mode] = {
                        notes,
                        intervals: intervalPatterns[mode],
                        triads: chords.triads,
                        fourNote: chords.fourNote,
                        fiveNote: chords.fiveNote,
                        sixNote: chords.sixNote
                    };
                }
            }
            return data;
        }

        function updateKeySelect() {
            const keySelect = document.getElementById('keySelect');
            keySelect.innerHTML = '';
            const notesList = currentNotation === 'sharp' ? sharpNotes : flatNotes;
            notesList.forEach(note => {
                const option = document.createElement('option');
                option.value = note;
                option.textContent = note;
                keySelect.appendChild(option);
            });
            keySelect.value = notesList.includes('C') ? 'C' : notesList[0];
        }

        function getRelativeModes(key, mode) {
            if (!modeOffsets[mode]) return [];
            const rootSemitone = getSemitone(key, currentNotation);
            const modeOffset = modeOffsets[mode];
            const parentIonianSemitone = (rootSemitone - modeOffset + 12) % 12;
            const relatives = [];
            Object.keys(modeOffsets).forEach(relMode => {
                const relOffset = modeOffsets[relMode];
                const relKeySemitone = (parentIonianSemitone + relOffset) % 12;
                const relKey = getNoteFromSemitone(relKeySemitone, currentNotation);
                if (`${relKey} ${relMode}` !== `${key} ${mode}`) {
                    relatives.push(`${relKey} ${relMode}`);
                }
            });
            return relatives;
        }

        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `${r}, ${g}, ${b}`;
        }

        function resizeCanvases() {
            const fretboard = document.getElementById('fretboardCanvas');
            const piano = document.getElementById('pianoCanvas');
            const maxWidth = Math.min(window.innerWidth - 20, 840);
            fretboard.width = maxWidth;
            fretboard.height = (maxWidth / 840) * 150;
            piano.width = maxWidth;
            piano.height = (maxWidth / 840) * 100;
        }

        function drawFretboard(notes) {
            const canvas = document.getElementById('fretboardCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const guitarStrings = getGuitarStrings(currentTuning);
            const stringSpacing = canvas.height / 6;
            const fretSpacing = canvas.width / maxFrets;
            const noteRadius = Math.min(12, canvas.width / 70);
            const stringOrder = currentStringOrder === 'lowBottom' ? guitarStrings.slice().reverse() : guitarStrings;

            ctx.strokeStyle = isHighContrast ? '#ffffff' : '#e0e0e0';
            ctx.lineWidth = 2;
            for (let i = 0; i < 6; i++) {
                ctx.beginPath();
                ctx.moveTo(0, i * stringSpacing + stringSpacing / 2);
                ctx.lineTo(canvas.width, i * stringSpacing + stringSpacing / 2);
                ctx.stroke();
            }

            for (let i = 0; i < maxFrets; i++) {
                ctx.lineWidth = (i === 1) ? 4 : 2;
                ctx.beginPath();
                ctx.moveTo(i * fretSpacing, 0);
                ctx.lineTo(i * fretSpacing, canvas.height);
                ctx.stroke();
            }

            ctx.fillStyle = isHighContrast ? '#ffeb3b' : themeColor;
            ctx.font = '10px Roboto';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            ctx.fillText('Fret 1', fretSpacing, 10);

            const markers = maxFrets > 8 ? [3, 5, 7, 9, 12] : [3, 5, 7];
            ctx.fillStyle = isHighContrast ? '#cccccc' : '#888';
            markers.forEach(fret => {
                if (fret >= maxFrets) return;
                if (fret === 12) {
                    ctx.beginPath();
                    ctx.arc(fret * fretSpacing + fretSpacing / 2, stringSpacing * 1.5, 8, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.beginPath();
                    ctx.arc(fret * fretSpacing + fretSpacing / 2, stringSpacing * 4.5, 8, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    ctx.beginPath();
                    ctx.arc(fret * fretSpacing + fretSpacing / 2, canvas.height / 2, 8, 0, Math.PI * 2);
                    ctx.fill();
                }
            });

            ctx.fillStyle = isHighContrast ? '#ffeb3b' : themeColor;
            ctx.font = '10px Roboto';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';
            for (let i = 0; i < maxFrets - 1; i++) {
                ctx.fillText(i, i * fretSpacing + fretSpacing / 2, canvas.height + 5);
            }

            ctx.fillStyle = isHighContrast ? '#ffeb3b' : themeColor;
            ctx.font = 'bold 12px Roboto';
            ctx.textAlign = 'right';
            ctx.textBaseline = 'middle';
            stringOrder.forEach((string, stringIndex) => {
                const label = `${string.note}${string.octave}`;
                ctx.fillText(label, 10, stringIndex * stringSpacing + stringSpacing / 2);
            });

            ctx.fillStyle = isHighContrast ? '#ffeb3b' : themeColor;
            ctx.font = '12px Roboto';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            stringOrder.forEach((string, stringIndex) => {
                const baseSemitone = getSemitone(string.note, currentNotation);
                for (let fret = 0; fret < maxFrets - 1; fret++) {
                    const semitone = (baseSemitone + fret) % 12;
                    const note = getNoteFromSemitone(semitone, currentNotation);
                    if (notes.includes(note)) {
                        const x = fret * fretSpacing + fretSpacing / 2;
                        const y = stringIndex * stringSpacing + stringSpacing / 2;
                        ctx.beginPath();
                        ctx.arc(x, y, noteRadius, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.fillStyle = isHighContrast ? '#000000' : '#1a1a1a';
                        ctx.fillText(note, x, y);
                        ctx.fillStyle = isHighContrast ? '#ffeb3b' : themeColor;
                    }
                }
            });
        }

        function drawPianoRoll(notes) {
            const canvas = document.getElementById('pianoCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const whiteKeys = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
            const blackKeyOffsets = [0, 1, 3, 4, 5];
            const themeColorRgb = hexToRgb(isHighContrast ? '#ffeb3b' : themeColor);

            const numWhiteKeys = 14;
            const keyWidth = canvas.width / numWhiteKeys;
            const blackKeyHeight = canvas.height * 0.65;
            const startingOctave = 3;

            for (let i = 0; i < numWhiteKeys; i++) {
                const x = i * keyWidth;
                const note = whiteKeys[i % 7];
                const octave = startingOctave + Math.floor(i / 7);
                const fullNote = note + octave;

                const grad = ctx.createLinearGradient(x, 0, x, canvas.height);
                grad.addColorStop(0, isHighContrast ? "#ffffff" : "#fafafa");
                grad.addColorStop(1, isHighContrast ? "#eeeeee" : "#dcdcdc");
                ctx.fillStyle = grad;
                ctx.strokeStyle = isHighContrast ? "#666666" : "#444";
                ctx.lineWidth = 1.2;
                ctx.beginPath();
                ctx.roundRect(x, 0, keyWidth, canvas.height, 3);
                ctx.fill();
                ctx.stroke();

                if (notes.includes(note)) {
                    ctx.fillStyle = `rgba(${themeColorRgb},0.35)`;
                    ctx.fillRect(x, 0, keyWidth, canvas.height);
                }

                ctx.font = notes.includes(note) ? 'bold 12px Roboto' : '11px Roboto';
                ctx.fillStyle = notes.includes(note) ? (isHighContrast ? '#ffeb3b' : themeColor) : (isHighContrast ? "#666666" : "#333");
                ctx.textAlign = 'center';
                ctx.fillText(fullNote, x + keyWidth / 2, canvas.height - 12);
            }

            for (let i = 0; i < numWhiteKeys; i++) {
                const note = whiteKeys[i % 7];
                const octave = startingOctave + Math.floor(i / 7);

                if (blackKeyOffsets.includes(i % 7)) {
                    const x = (i + 1) * keyWidth - keyWidth / 4;
                    const grad = ctx.createLinearGradient(x, 0, x, blackKeyHeight);
                    grad.addColorStop(0, isHighContrast ? "#444444" : "#333");
                    grad.addColorStop(1, isHighContrast ? "#222222" : "#000");
                    ctx.fillStyle = grad;
                    ctx.strokeStyle = isHighContrast ? "#666666" : "#111";
                    ctx.beginPath();
                    ctx.roundRect(x - keyWidth / 4, 0, keyWidth / 2, blackKeyHeight, 3);
                    ctx.fill();
                    ctx.stroke();

                    const semitone = (getSemitone(note, 'sharp') + 1) % 12;
                    const blackNote = getNoteFromSemitone(semitone, currentNotation) + octave;

                    if (notes.includes(getNoteFromSemitone(semitone, currentNotation))) {
                        ctx.fillStyle = `rgba(${themeColorRgb},0.6)`;
                        ctx.fillRect(x - keyWidth / 4, 0, keyWidth / 2, blackKeyHeight);
                    }

                    ctx.font = notes.includes(getNoteFromSemitone(semitone, currentNotation)) ? 'bold 11px Roboto' : '10px Roboto';
                    ctx.fillStyle = notes.includes(getNoteFromSemitone(semitone, currentNotation)) ? (isHighContrast ? '#ffeb3b' : themeColor) : (isHighContrast ? "#ffffff" : "#eee");
                    ctx.textAlign = 'center';
                    ctx.fillText(blackNote, x, blackKeyHeight - 10);
                }
            }
        }

        function updateTable() {
            const key = document.getElementById('keySelect').value;
            const mode = document.getElementById('modeSelect').value;
            if (!modesData[key] || !modesData[key][mode]) return;
            const data = modesData[key][mode];
            const relativeModes = getRelativeModes(key, mode);
            let relativeHtml = `You have selected <span>${key} ${mode}</span>`;
            if (relativeModes.length > 0) {
                relativeHtml += `, which is also the same note structure as: ${relativeModes.join(", ")}`;
            } else {
                relativeHtml += `, a non-diatonic scale.`;
            }
            document.getElementById('relativeModes').innerHTML = relativeHtml;
            document.getElementById('fretboardKeyMode').innerHTML = `(${key} ${mode})`;
            document.getElementById('pianoKeyMode').innerHTML = `(${key} ${mode})`;
            let tableHtml = `
                <tr><td>Notes</td><td>${data.notes.join(", ")}</td></tr>
                <tr><td>Intervals</td><td>${data.intervals.join(", ")}</td></tr>
                <tr><td>Emotion/Feeling</td><td>${modeEmotions[mode] || "N/A"}</td></tr>
                <tr><td>Triads</td><td>${data.triads.join(", ")}</td></tr>
                <tr><td>Four-Note Chords</td><td>${data.fourNote.join(", ")}</td></tr>
            `;
            document.getElementById('tableBody').innerHTML = tableHtml;
            resizeCanvases();
            drawFretboard(data.notes);
            drawPianoRoll(data.notes);
        }

        function debounce(func, wait) {
            return function() {
                clearTimeout(debounceTimeout);
                debounceTimeout = setTimeout(() => func.apply(this, arguments), wait);
            };
        }

        document.addEventListener("DOMContentLoaded", () => {
            currentNotation = 'sharp';
            currentTuning = 'standard';
            currentStringOrder = 'highBottom';
            themeColor = '#00ffcc';
            document.documentElement.style.setProperty('--theme-color', themeColor);
            document.documentElement.style.setProperty('--theme-color-rgb', hexToRgb(themeColor));
            modesData = generateData(currentNotation);
            updateKeySelect();

            document.getElementById('notationSelect').addEventListener('change', (e) => {
                currentNotation = e.target.value;
                modesData = generateData(currentNotation);
                updateKeySelect();
                updateTable();
            });
            document.getElementById('tuningSelect').addEventListener('change', (e) => {
                currentTuning = e.target.value;
                updateTable();
            });
            document.getElementById('stringOrderSelect').addEventListener('change', (e) => {
                currentStringOrder = e.target.value;
                updateTable();
            });
            document.getElementById('themeColor').addEventListener('input', (e) => {
                themeColor = e.target.value;
                document.documentElement.style.setProperty('--theme-color', themeColor);
                document.documentElement.style.setProperty('--theme-color-rgb', hexToRgb(themeColor));
                updateTable();
            });
            document.getElementById('keySelect').addEventListener('change', debounce(updateTable, 300));
            document.getElementById('modeSelect').addEventListener('change', debounce(updateTable, 300));
            window.addEventListener('resize', debounce(() => {
                maxFrets = window.innerWidth <= 480 && !isFullFretboard ? 8 : 14;
                resizeCanvases();
                updateTable();
            }, 300));

            document.getElementById('contrastToggle').addEventListener('click', () => {
                isHighContrast = !isHighContrast;
                document.body.classList.toggle('high-contrast');
                document.getElementById('contrastToggle').textContent = isHighContrast ? 'Toggle Normal Contrast' : 'Toggle High Contrast';
                document.documentElement.style.setProperty('--theme-color', isHighContrast ? '#ffeb3b' : themeColor);
                document.documentElement.style.setProperty('--theme-color-rgb', hexToRgb(isHighContrast ? '#ffeb3b' : themeColor));
                updateTable();
            });

            document.getElementById('pianoToggle').addEventListener('click', () => {
                document.body.classList.toggle('piano-visible');
                document.getElementById('pianoToggle').textContent = document.body.classList.contains('piano-visible') ? 'Hide Piano Roll' : 'Show Piano Roll';
                if (document.body.classList.contains('piano-visible')) {
                    resizeCanvases();
                    drawPianoRoll(modesData[document.getElementById('keySelect').value][document.getElementById('modeSelect').value].notes);
                }
            });

            document.getElementById('fretboardToggle').addEventListener('click', () => {
                isFullFretboard = !isFullFretboard;
                maxFrets = isFullFretboard ? 14 : (window.innerWidth <= 480 ? 8 : 14);
                document.getElementById('fretboardToggle').textContent = isFullFretboard ? 'Show Compact Fretboard' : 'Show Full Fretboard';
                updateTable();
            });

            resizeCanvases();
            updateTable();
        });
    </script>
</body>
</html>
